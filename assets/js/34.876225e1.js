(window.webpackJsonp=window.webpackJsonp||[]).push([[34],{795:function(e,t,a){e.exports=a.p+"assets/img/aad-app-registrations.c021d771.png"},796:function(e,t,a){e.exports=a.p+"assets/img/gh-env-secrets.5c3778f5.png"},797:function(e,t,a){e.exports=a.p+"assets/img/az-frontend-tag-filter.1ce6f61a.png"},798:function(e,t,a){e.exports=a.p+"assets/img/aad-adjust-reply-url.82e67e11.png"},799:function(e,t,a){e.exports=a.p+"assets/img/aad-scmfe-consent.a485e23a.png"},800:function(e,t,a){e.exports=a.p+"assets/img/aad-principal-name.3cd4706f.png"},935:function(e,t,a){"use strict";a.r(t);var n=a(35),s=Object(n.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"üíé-challenge-3-azure-ad-applications-and-deployment-to-github-environments-üíé"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#üíé-challenge-3-azure-ad-applications-and-deployment-to-github-environments-üíé"}},[e._v("#")]),e._v(" üíé Challenge 3: Azure AD applications and deployment to GitHub environments üíé")]),e._v(" "),n("h2",{attrs:{id:"here-is-what-you-will-learn-üéØ"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#here-is-what-you-will-learn-üéØ"}},[e._v("#")]),e._v(" Here is what you will learn üéØ")]),e._v(" "),n("p",[e._v("‚è≤Ô∏è "),n("em",[e._v("Est. time to complete: 30 min.")]),e._v(" ‚è≤Ô∏è")]),e._v(" "),n("ul",[n("li",[e._v("Create Azure AD's client and server applications to integrate Azure AD into the sample application")]),e._v(" "),n("li",[e._v("Configure GitHub envrionement's to deploy to a development and testing stage")]),e._v(" "),n("li",[e._v("Deploy the shared Azure resources of the sample application")]),e._v(" "),n("li",[e._v("Deploy the frontend and adjust Reply Urls")])]),e._v(" "),n("h2",{attrs:{id:"table-of-content"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#table-of-content"}},[e._v("#")]),e._v(" Table of content")]),e._v(" "),n("ol",[n("li",[n("a",{attrs:{href:"#goal"}},[e._v("Goal")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#create-azure-ad-applications"}},[e._v("Create Azure AD applications")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#create-azure-ad-applications"}},[e._v("Create development and test environments")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#activate-the-cicd-workflow"}},[e._v("Activate the CI/CD workflow")])]),e._v(" "),n("li",[n("a",{attrs:{href:"#summary"}},[e._v("Summary")])])]),e._v(" "),n("h2",{attrs:{id:"goal"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#goal"}},[e._v("#")]),e._v(" Goal")]),e._v(" "),n("p",[e._v("In the previous challenges you have learned some basics about the OpenID Connect\nand OAuth2 flows. You have seen how you can sign in users and how to acquire an\naccess token for an Azure AD's protected resource. In this challenge we will\nintegrate Azure AD into the sample application step by step. We will use GitHub\nActions workflows to deploy the sample application to Azure. Don't worry, the\nneeded GitHub Actions workflows are already implemented, but we need to take\nsome steps to activate them.")]),e._v(" "),n("h2",{attrs:{id:"create-azure-ad-applications"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create-azure-ad-applications"}},[e._v("#")]),e._v(" Create Azure AD applications")]),e._v(" "),n("p",[e._v("In "),n("RouterLink",{attrs:{to:"/day5/challenges/02-challenge.html"}},[e._v("Challenge 2")]),e._v(" you have already seen how to create an Azure\nAD client application to sign in users and how to create an API application that\nexposes OAuth2 permissions. We have to do the same for the sample application.")],1),e._v(" "),n("p",[e._v("There is already a script available in the repository to create both\napplications for you. It is located here:\n"),n("a",{attrs:{href:"https://github.com/azuredevcollege/trainingdays/tree/master/day5/apps/infrastructure/scripts/aad-integration.sh",target:"_blank",rel:"noopener noreferrer"}},[e._v("day5/apps/infrastructure/scripts/aad-integration.sh"),n("OutboundLink")],1),e._v(".\nYou need to run it in a bash/Shell environment.")]),e._v(" "),n("p",[e._v("The script creates the server application first and then the client application\nfor the sample application. It also uses a\n"),n("a",{attrs:{href:"https://github.com/azuredevcollege/trainingdays/tree/master/day5/apps/infrastructure/scripts/oauth2-permissions.json",target:"_blank",rel:"noopener noreferrer"}},[e._v("oauth2-permissions.json"),n("OutboundLink")],1),e._v("\nfile where all needed OAuth2 permission are defined.")]),e._v(" "),n("p",[e._v("After running the script twice, we registered the following applications in\nAzure AD:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(795),alt:"Azure AD Application Registration"}})]),e._v(" "),n("p",[e._v("For each environment two applications are registered. One for the client and one\nfor all APIs of the sample application.")]),e._v(" "),n("h3",{attrs:{id:"run-the-script"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#run-the-script"}},[e._v("#")]),e._v(" Run the script")]),e._v(" "),n("p",[e._v("Open a shell and use Azure CLI to connect to the Azure AD Tenant where you want\nto create the applications (you can also use the Azure Cloud Shell). If you have\ncreated a new Azure AD that is not linked to an Azure subscription, add the\nadditional option "),n("code",[e._v("--allow-no-subscription")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[e._v("az login --allow-no-subscription\n")])])]),n("p",[e._v("You must run the script twice:")]),e._v(" "),n("ul",[n("li",[e._v("once for creating the applications for the "),n("code",[e._v("Development")]),e._v(" stage")]),e._v(" "),n("li",[e._v("once for creating the applications for the "),n("code",[e._v("Testing")]),e._v(" stage")])]),e._v(" "),n("p",[e._v("Use the following parameters to run the script for the "),n("code",[e._v("Development")]),e._v(" stage and don't forget to replace the "),n("code",[e._v("TENANT_DOMAIN")]),e._v(":")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("Parameter")]),e._v(" "),n("th",[e._v("Value")])])]),e._v(" "),n("tbody",[n("tr",[n("td",[n("em",[e._v("API-APP-NAME")])]),e._v(" "),n("td",[e._v("scmapi-dev")])]),e._v(" "),n("tr",[n("td",[n("em",[e._v("API-APP-URI")])]),e._v(" "),n("td",[n("a",{attrs:{href:"http://TENANT_DOMAIN.onmicrosoft.com/scmapi-dev",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://TENANT_DOMAIN.onmicrosoft.com/scmapi-dev"),n("OutboundLink")],1)])]),e._v(" "),n("tr",[n("td",[n("em",[e._v("UI-APP-NAME")])]),e._v(" "),n("td",[e._v("scmfe-dev")])])])]),e._v(" "),n("p",[e._v("Use the following parameter for the "),n("code",[e._v("Testing")]),e._v(" stage:")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("Parameter")]),e._v(" "),n("th",[e._v("Value")])])]),e._v(" "),n("tbody",[n("tr",[n("td",[n("em",[e._v("API-APP-NAME")])]),e._v(" "),n("td",[e._v("scmapi-test")])]),e._v(" "),n("tr",[n("td",[n("em",[e._v("API-APP-URI")])]),e._v(" "),n("td",[n("a",{attrs:{href:"http://TENANT_DOMAIN.onmicrosoft.com/scmapi-test",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://TENANT_DOMAIN.onmicrosoft.com/scmapi-test"),n("OutboundLink")],1)])]),e._v(" "),n("tr",[n("td",[n("em",[e._v("UI-APP-NAME")])]),e._v(" "),n("td",[e._v("scmfe-test")])])])]),e._v(" "),n("p",[e._v("Navigate to the directory\n"),n("a",{attrs:{href:"https://github.com/azuredevcollege/trainingdays/tree/master/day5/apps/infrastructure/scripts",target:"_blank",rel:"noopener noreferrer"}},[e._v("day5/apps/infrastructure/scripts"),n("OutboundLink")],1),e._v(" which\ncontains the script and the "),n("code",[e._v("oauth2-permissions.json")]),e._v(" configuration file.")]),e._v(" "),n("p",[e._v("Run the script twice:")]),e._v(" "),n("ul",[n("li",[e._v("once for the "),n("code",[e._v("Development")])]),e._v(" "),n("li",[e._v("once for the "),n("code",[e._v("Testing")]),e._v("stage.")])]),e._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),n("p",[e._v("üìù Note down the "),n("code",[e._v("UI AppId")]),e._v(" and "),n("code",[e._v("API AppId")]),e._v(" from the output after each run!")])]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[e._v("./aad-integration.sh "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("API-APP-NAME"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("API-APP-URI"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("UI-APP-NAME"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),n("p",[e._v("If your bash does not find jq this could help:")]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("sudo")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("apt-get")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("install")]),e._v(" jq\n")])])]),n("p",[e._v("The output:")]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(".\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("..")]),e._v(".\nUI AppId "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("UI_APP_NAME"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(": "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("please note down"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\nAPI AppId "),n("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("for")]),e._v(" app "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("API_APP_NAME"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(": "),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v("<")]),e._v("please note down"),n("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v("\n")])])]),n("h3",{attrs:{id:"validate-the-applications-in-azure-ad"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#validate-the-applications-in-azure-ad"}},[e._v("#")]),e._v(" Validate the Applications in Azure AD")]),e._v(" "),n("p",[e._v("After the script has been executed twice, navigate to your Azure AD and inspect\nthe previously created applications. You should see four new applications.")]),e._v(" "),n("h2",{attrs:{id:"create-development-and-test-environments"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create-development-and-test-environments"}},[e._v("#")]),e._v(" Create development and test environments")]),e._v(" "),n("p",[e._v("Now it's time to prepare GitHub environments to deploy the sample application to\na "),n("em",[e._v("Dev")]),e._v(" and "),n("em",[e._v("Test")]),e._v(" stage for Day5 with Azure AD integration. A GitHub\nenvironment can be configured with protection rules and secrets. A workflow job\ncan reference environments to use environment's protection rules and secrets.")]),e._v(" "),n("h3",{attrs:{id:"dev-environment"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#dev-environment"}},[e._v("#")]),e._v(" Dev environment")]),e._v(" "),n("p",[e._v("Let us first create the environment for the Development stage.")]),e._v(" "),n("p",[e._v("Navigate to the imported "),n("em",[e._v("trainigdays")]),e._v(" repository in your organization and go to\nthe repository's settings. Open the "),n("em",[e._v("Environments")]),e._v(" view and create the\nenvironment "),n("code",[e._v("day5-scm-dev")]),e._v(". As we only want to deploy the master branch to that\nenvironment, we limit what branches can deploy to that environment.")]),e._v(" "),n("p",[e._v("Select the "),n("code",[e._v("Deployment branches")]),e._v(" dropdown and choose the "),n("code",[e._v("Selected branches")]),e._v("\noption. Add the "),n("code",[e._v("master")]),e._v(" branch as allowed branch.")]),e._v(" "),n("p",[e._v("We need to add some secrets, which are accessed later in the GitHub Actions\nworkflow.")]),e._v(" "),n("p",[e._v("Use the "),n("code",[e._v("Add Secret")]),e._v(" button to add a new secret named "),n("code",[e._v("SQL_PASSWORD")]),e._v(".")]),e._v(" "),n("p",[e._v("You can generate a strong password by using the following command:")]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[e._v("pwgen -n "),n("span",{pre:!0,attrs:{class:"token number"}},[e._v("20")]),e._v(" -y\n")])])]),n("p",[e._v("Now, add the following secrets for the Azure AD integration:")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("Secret name")]),e._v(" "),n("th",[e._v("Value")])])]),e._v(" "),n("tbody",[n("tr",[n("td",[e._v("AAD_API_CLIENT_ID")]),e._v(" "),n("td",[n("em",[e._v("the AppId of the Azure AD's application registration for the APIs")])])]),e._v(" "),n("tr",[n("td",[e._v("AAD_API_CLIENT_ID_URI")]),e._v(" "),n("td",[n("a",{attrs:{href:"http://scmapi-dev",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://scmapi-dev"),n("OutboundLink")],1)])]),e._v(" "),n("tr",[n("td",[e._v("AAD_FE_CLIENT_ID")]),e._v(" "),n("td",[n("em",[e._v("the AppId of the Azure AD's application registration for the UI client")])])]),e._v(" "),n("tr",[n("td",[e._v("AAD_DOMAIN")]),e._v(" "),n("td",[n("em",[e._v("your Azure AD's domain name e.g. azuredevcollege.onmicrosoftonline.com")])])]),e._v(" "),n("tr",[n("td",[e._v("AAD_INSTANCE")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://login.microsoftonline.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://login.microsoftonline.com"),n("OutboundLink")],1)])]),e._v(" "),n("tr",[n("td",[e._v("AAD_TENANT_ID")]),e._v(" "),n("td",[n("em",[e._v("your Azure AD's tenant or directory id")])])])])]),e._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),n("p",[e._v("‚ö†Ô∏è Make sure you use the values you used for the application registration script\nfor the development environment !")])]),e._v(" "),n("p",[e._v("At the end your secrets for the development environment looks like this:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(796),alt:"GitHub Dev environment config"}})]),e._v(" "),n("h3",{attrs:{id:"test-environment"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#test-environment"}},[e._v("#")]),e._v(" Test environment")]),e._v(" "),n("p",[e._v("Create another environment for the Test stage and name it "),n("code",[e._v("day5-scm-test")]),e._v(". As we\nwant a manual approval, before a deployment is executed to that environment, we\nset "),n("em",[e._v("Environment protection rules")]),e._v(". Activate "),n("code",[e._v("Required reviewers")]),e._v(" and add a\nreviewer.")]),e._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),n("p",[e._v("üìù Add yourself as a Reviewer, otherwise you will have to wait until the\nselected reviewer approves the deployment request.")])]),e._v(" "),n("p",[e._v("Make sure to again configure the selected branches and the "),n("code",[e._v("secrets")]),e._v(" as following:")]),e._v(" "),n("table",[n("thead",[n("tr",[n("th",[e._v("Secret name")]),e._v(" "),n("th",[e._v("Value")])])]),e._v(" "),n("tbody",[n("tr",[n("td",[e._v("AAD_API_CLIENT_ID")]),e._v(" "),n("td",[n("em",[e._v("the AppId of the Azure AD's application registration for the APIs")])])]),e._v(" "),n("tr",[n("td",[e._v("AAD_API_CLIENT_ID_URI")]),e._v(" "),n("td",[n("a",{attrs:{href:"http://scmapi-test",target:"_blank",rel:"noopener noreferrer"}},[e._v("http://scmapi-test"),n("OutboundLink")],1)])]),e._v(" "),n("tr",[n("td",[e._v("AAD_FE_CLIENT_ID")]),e._v(" "),n("td",[n("em",[e._v("the AppId of the Azure AD's application registration for the UI client")])])]),e._v(" "),n("tr",[n("td",[e._v("AAD_DOMAIN")]),e._v(" "),n("td",[n("em",[e._v("your Azure AD's domain name e.g. azuredevcollege.onmicrosoftonline.com")])])]),e._v(" "),n("tr",[n("td",[e._v("AAD_INSTANCE")]),e._v(" "),n("td",[n("a",{attrs:{href:"https://login.microsoftonline.com",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://login.microsoftonline.com"),n("OutboundLink")],1)])]),e._v(" "),n("tr",[n("td",[e._v("AAD_TENANT_ID")]),e._v(" "),n("td",[n("em",[e._v("your Azure AD's tenant or directory id")])])]),e._v(" "),n("tr",[n("td",[e._v("SQL_PASSWORD")]),e._v(" "),n("td",[n("em",[e._v("your password")])])])])]),e._v(" "),n("div",{staticClass:"custom-block warning"},[n("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),n("p",[e._v("‚ö†Ô∏è Make sure you use the values you used for the application registration script\nfor the test environment !")])]),e._v(" "),n("h2",{attrs:{id:"create-a-service-principal-and-store-the-secret"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#create-a-service-principal-and-store-the-secret"}},[e._v("#")]),e._v(" Create a service principal and store the secret")]),e._v(" "),n("p",[e._v("To allow GitHub to interact with our Azure Subscription we need to create a\nService principal in our Azure Active Directory. If you have already created a\nservice principal and added it to your repository's secrets, you can skip this\nstep and continue with "),n("a",{attrs:{href:"#activate-the-cicd-workflow"}},[e._v("Activate the CI/CD\nworkflow")]),e._v(".")]),e._v(" "),n("p",[e._v("Create a new Service Principal and copy the credentials from the output of the\nfollowing command:")]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# Change the name and use your subscription-id to create a Service Principal.")]),e._v("\naz ad sp create-for-rbac --name "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"{name}-github-actions-sp"')]),e._v(" --sdk-auth --role contributor --scopes /subscriptions/"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("subscription-id"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),n("p",[e._v("Now we need to store the Service Principal's credentials. Navigate to the\nimported "),n("em",[e._v("trainingdays")]),e._v(" repository "),n("code",[e._v("Settings > Secrets")]),e._v("page and add a new\nrepository secret named "),n("code",[e._v("AZURE_CREDENTIALS")]),e._v(".")]),e._v(" "),n("h2",{attrs:{id:"activate-the-ci-cd-workflow"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#activate-the-ci-cd-workflow"}},[e._v("#")]),e._v(" Activate the CI/CD workflow")]),e._v(" "),n("p",[e._v("Now we have everything prepared to active the CI/CD workflow. First, checkout\nthe master branch, pull changes and create a new branch "),n("code",[e._v("cicd/aad-common")])]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" checkout master\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" pull\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" branch cicd/aad-common\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" checkout cicd/aad-common\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[e._v("# or")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" checkout -b cicd/aad-common\n")])])]),n("p",[e._v("There is already a Visual Studio Code workspace prepared which we can simple\nopen with:")]),e._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v("cd")]),e._v(" day5\ncode ./day5.code-workspace\n")])])]),n("p",[e._v("All known application components are already available in this workspace. In\naddition, we see two more directories:")]),e._v(" "),n("ul",[n("li",[n("strong",[e._v("workflows")]),e._v(", here we find all prepared GitHub Actions workflow for the Azure\nDeveloper College")]),e._v(" "),n("li",[n("strong",[e._v("infrastructure")]),e._v(", here we find all bicep modules to deploy the needed Azure\ninfrastructure for all components")])]),e._v(" "),n("h3",{attrs:{id:"github-actions-workflows"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#github-actions-workflows"}},[e._v("#")]),e._v(" GitHub Actions workflows")]),e._v(" "),n("p",[e._v("Now it's time to have a look at the already prepared GitHub Actions workflows\nfor Day5. You can find all workflows in the workspace folder "),n("code",[e._v("workflows")]),e._v(". Today\nwe focus on all workflows with the prefix "),n("code",[e._v("day5-")]),e._v(". First, we will prepare the\nworkflow for the shared Azure resources. Open the workflow\n"),n("code",[e._v("workflows/day5-scm-common.yml")]),e._v(". This workflow, like all others, is triggered\nwhen a pull request is opened or changes were pushed to the master branch. In\naddition, filters are applied to individual files:")]),e._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" day5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("scm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("common\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("on")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("push")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("branches")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" master\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" day5/apps/infrastructure/bicep/common/"),n("span",{pre:!0,attrs:{class:"token important"}},[e._v("**")]),e._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" .github/workflows/day5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("scm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("common.yml\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("pull_request")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("branches")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" master\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" day5/apps/infrastructure/bicep/common/"),n("span",{pre:!0,attrs:{class:"token important"}},[e._v("**")]),e._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" .github/workflows/day5"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("scm"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("common.yml\n\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("workflow_dispatch")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n")])])]),n("p",[e._v("With the trigger "),n("code",[e._v("workflow_dispatch")]),e._v("it is possible to trigger the workflow\nmanually.")]),e._v(" "),n("h3",{attrs:{id:"prepare-the-workflow-and-create-a-pull-request"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-workflow-and-create-a-pull-request"}},[e._v("#")]),e._v(" Prepare the workflow and create a pull request")]),e._v(" "),n("p",[e._v("Now it's time to prepare the workflow which rolls out the shared Azure resources\nfor the Azure Developer College's sample application. We have already cloned the\nrepository and created a new branch "),n("code",[e._v("cicd/aad-common")]),e._v(".")]),e._v(" "),n("p",[e._v("Open the workflow "),n("code",[e._v("day5-scm-common.yml")]),e._v(" and replace the organization name in\neach job condition with your organization's name:")]),e._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" github.repository == '<your organisation name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")]),e._v("/trainingdays'\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("...")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("deploy-to-dev")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" (github.repository == '<your organisation name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")]),e._v("/trainingdays') "),n("span",{pre:!0,attrs:{class:"token important"}},[e._v("&&")]),e._v(" ((github.event_name == 'push') "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),e._v(" (github.event_name == 'workflow_dispatch'))\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("...")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("delpoy-to-test")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" (github.repository == '<your organisation name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")]),e._v("/trainingdays') "),n("span",{pre:!0,attrs:{class:"token important"}},[e._v("&&")]),e._v(" ((github.event_name == 'push') "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("|")]),e._v(" (github.event_name == 'workflow_dispatch'))\n")])])]),n("p",[e._v("Save the file, commit your changes and push the branch to the remote repository:")]),e._v(" "),n("div",{staticClass:"language-Shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" commit -m "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Change org name in common workflow"')]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" push --set-upstream origin cicd/aad-common\n")])])]),n("p",[e._v("Now, create a pull request to merge the branch "),n("code",[e._v("cicd/aad-common")]),e._v(" into the\n"),n("code",[e._v("master")]),e._v(" branch. Set "),n("code",[e._v("Deploy shared Azure resources for AAD integration")]),e._v(" as\ntitle.")]),e._v(" "),n("div",{staticClass:"custom-block tip"},[n("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),n("p",[e._v("üìù If you want, you can add a reviewer. However, since you as the Administrator\nare excluded from the branch rules, you can merge the pull request without a\nreview approval.")])]),e._v(" "),n("p",[e._v("Wait a few seconds, until the status checks are triggered and successful.")]),e._v(" "),n("p",[e._v("Now merge the pull request and navigate to your repository' action page. You\nshould see that the "),n("code",[e._v("day5-scm-common")]),e._v(" workflow is triggered after a few seconds.")]),e._v(" "),n("p",[e._v("After the "),n("code",[e._v("dev")]),e._v(" environment is deployed, go to the Azure portal an checkout the\nnewly created resource group and resources. The workflow is now in the\n"),n("code",[e._v("waiting")]),e._v("state, because a reviewer must approve the deployment to the "),n("code",[e._v("test")]),e._v("\nenvironment:")]),e._v(" "),n("p",[e._v("Review the pending deployment, leave a comment and "),n("code",[e._v("Approve and deploy")]),e._v(".")]),e._v(" "),n("p",[e._v("Now the test environment will be deployed. After the deployment is finished, we\nhave another resource group with all shared Azure resources in the test\nenvironment.")]),e._v(" "),n("h2",{attrs:{id:"deploy-the-frontend-and-adjust-the-redirect-uris"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#deploy-the-frontend-and-adjust-the-redirect-uris"}},[e._v("#")]),e._v(" Deploy the frontend and adjust the Redirect URIs")]),e._v(" "),n("p",[e._v("Now it's time to deploy the frontend and adjust the needed Redirect URIs for the\nregistered Azure AD applications. Azure AD issues tokens to known endpoints,\nonly. The frontend is hosted as a "),n("code",[e._v("Static website")]),e._v(" in an Azure storage account.\nAs the storage account is created with a random name in the frontend deployment,\nwe don't know the frontend url at the moment. First we need to deploy the\nfrontend to each environment and then adjust the Redirect URIss in the Azure\nAD's application registration for each environment.")]),e._v(" "),n("h3",{attrs:{id:"activate-the-workflow"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#activate-the-workflow"}},[e._v("#")]),e._v(" Activate the workflow")]),e._v(" "),n("p",[e._v("Let's pull the latest changes first:")]),e._v(" "),n("div",{staticClass:"language-Shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" checkout master\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" pull\n")])])]),n("p",[e._v("Next, create a new feature branch "),n("code",[e._v("cicd/aad-frontend")]),e._v(":")]),e._v(" "),n("div",{staticClass:"language-Shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" checkout -b cicd/aad-frontend\n")])])]),n("p",[e._v("In VS Code, open the workflow "),n("code",[e._v("day5-scm-frontend.yml")]),e._v(" and replace the\norganization name in each job condition with your organization's name:")]),e._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("build-bicep")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("if")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" github.repository == '<your organisation name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(">")]),e._v("/trainingdays'\n")])])]),n("p",[e._v("Save the file, commit your changes and push the branch to the remote repository:")]),e._v(" "),n("div",{staticClass:"language-Shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("add")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[e._v(".")]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" commit -m "),n("span",{pre:!0,attrs:{class:"token string"}},[e._v('"Change org name in frontend workflow"')]),e._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[e._v("git")]),e._v(" push --set-upstream origin cicd/aad-frontend\n")])])]),n("p",[e._v("Now, create a pull request to merge the branch "),n("code",[e._v("cicd/aad-frontend")]),e._v(" into the\n"),n("code",[e._v("master")]),e._v(" branch. Set "),n("code",[e._v("Deploy frontend for AAD integration")]),e._v(" as title.")]),e._v(" "),n("p",[e._v("Wait a few seconds, until the status checks are triggered and successful.")]),e._v(" "),n("p",[e._v("Now merge the pull request and navigate to your repository' action page. You\nshould see that the "),n("code",[e._v("day5-scm-frontend")]),e._v(" workflow is triggered after a few\nseconds.")]),e._v(" "),n("p",[e._v("The workflow is now in the "),n("code",[e._v("waiting")]),e._v("state, because a reviewer must approve the\ndeployment to the "),n("code",[e._v("test")]),e._v(" environment:")]),e._v(" "),n("p",[e._v("Review the pending deployment, leave a comment and "),n("code",[e._v("Approve and deploy")]),e._v(".")]),e._v(" "),n("h3",{attrs:{id:"adjust-the-redirect-uris-in-the-azure-ad-s-application-registrations"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#adjust-the-redirect-uris-in-the-azure-ad-s-application-registrations"}},[e._v("#")]),e._v(" Adjust the Redirect URIs in the Azure AD's application registrations")]),e._v(" "),n("p",[e._v("After the deployment is finished, we need to adjust the Redirect URIs in the\nAzure AD applications for each environment.")]),e._v(" "),n("p",[e._v("Navigate to the Azure portal and go to the resource group for the development\nenvironment. The name of the resource group starts with "),n("code",[e._v("rg-scm-devday5-")]),e._v(" and\nend with your GitHub organization name "),n("code",[e._v("rg-scm-devday5-<your organization name>")]),e._v(". We need to find the storage account where the frontend is hosted in a\nstatic website. The deployment created some Azure "),n("code",[e._v("Tags")]),e._v(" to group the used Azure\nresources regarding their bounded context. Within the resource group you can set\nfilters in the "),n("code",[e._v("Resources")]),e._v(" details view.")]),e._v(" "),n("p",[e._v("Apply the following filter:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(797),alt:"Azure resource group filter"}})]),e._v(" "),n("p",[e._v("As a result we see one storage account. Open the storage account and go to the\nsection "),n("code",[e._v("Static website")]),e._v(". Here you can find the primary endpoint of the frontend\nin the development environment. Copy the url.")]),e._v(" "),n("p",[e._v("Next, navigate to "),n("code",[e._v("Azure Active Directory > App registrations")]),e._v(", select "),n("code",[e._v("All applications")]),e._v(" and search for "),n("code",[e._v("scmfe-dev")]),e._v(". Open the application and go to\n"),n("code",[e._v("Authentication")]),e._v(". Add the "),n("code",[e._v("Redirect URIs")]),e._v(" you copied to your clipboard and save\nthe changes:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(798),alt:"Azure AD adjust Redirect URIs"}})]),e._v(" "),n("p",[e._v("Please repeat these steps for the application in the "),n("code",[e._v("test")]),e._v(" environment to\nadjust the Redirect URIs, too.")]),e._v(" "),n("h3",{attrs:{id:"browse-the-application"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#browse-the-application"}},[e._v("#")]),e._v(" Browse the application")]),e._v(" "),n("p",[e._v("Open a private browser window and navigate to the frontend of the development\nenvironment. If everything is configured correctly, you are redirected to Azure\nAD. Log in and give the app the necessary OAuth2 permissions to access your data\non your behalf:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(799),alt:"Scm Frontend consent"}})]),e._v(" "),n("p",[e._v("Back in the application, you see your principal name in the right upper corner:")]),e._v(" "),n("p",[n("img",{attrs:{src:a(800),alt:"Azure AD User's principla name"}})]),e._v(" "),n("h2",{attrs:{id:"summary"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#summary"}},[e._v("#")]),e._v(" Summary")]),e._v(" "),n("p",[e._v("In this challenge we have registered four applications in Azure AD. Two\napplications for the frontend and two applications for the back end. Each\nfrontend and backend application is assigned to one environment. We have\nprepared two GitHub environments and set the necessary secrets to integrate into\nAzure AD. The shared Azure resources and the frontend are already deployed to\nthe "),n("code",[e._v("dev")]),e._v("and "),n("code",[e._v("test")]),e._v("environment. Next, we go into the breakout session and roll\nout the complete application.")]),e._v(" "),n("p",[n("RouterLink",{attrs:{to:"/day5/challenges/02-challenge.html"}},[e._v("‚óÄ Previous challenge")]),e._v(" | "),n("RouterLink",{attrs:{to:"/day5/"}},[e._v("üîº Day 5")]),e._v(" | "),n("RouterLink",{attrs:{to:"/day5/challenges/04-breakout.html"}},[e._v("Next challenge ‚ñ∂")])],1)])}),[],!1,null,null,null);t.default=s.exports}}]);